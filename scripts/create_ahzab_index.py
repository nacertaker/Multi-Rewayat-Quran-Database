"""
إنشاء فهرس الأحزاب والأرباع لكل رواية
القرآن مقسم إلى:
- 30 جزء
- 60 حزب (كل جزء = حزبين)
- 240 ربع (كل حزب = 4 أرباع)
"""

import json
import sys
from pathlib import Path

sys.stdout.reconfigure(encoding='utf-8')

# بيانات الأحزاب والأرباع (معيارية لجميع الروايات)
# كل ربع يُحدد ببداية السورة والآية
# المصدر: مصحف المدينة المنورة

QUARTERS = [
    # الجزء 1
    (1, 1, 1),    # ربع 1: الفاتحة 1
    (1, 2, 2, 26),  # ربع 2: البقرة 26
    (1, 3, 2, 44),  # ربع 3: البقرة 44
    (1, 4, 2, 60),  # ربع 4: البقرة 60
    (1, 5, 2, 75),  # ربع 5: البقرة 75
    (1, 6, 2, 92),  # ربع 6: البقرة 92
    (1, 7, 2, 106), # ربع 7: البقرة 106
    (1, 8, 2, 124), # ربع 8: البقرة 124
    # الجزء 2
    (2, 1, 2, 142), # ربع 1: البقرة 142
    (2, 2, 2, 158), # ربع 2: البقرة 158
    (2, 3, 2, 177), # ربع 3: البقرة 177
    (2, 4, 2, 189), # ربع 4: البقرة 189
    (2, 5, 2, 203), # ربع 5: البقرة 203
    (2, 6, 2, 219), # ربع 6: البقرة 219
    (2, 7, 2, 233), # ربع 7: البقرة 233
    (2, 8, 2, 243), # ربع 8: البقرة 243
    # الجزء 3
    (3, 1, 2, 253), # ربع 1: البقرة 253
    (3, 2, 2, 263), # ربع 2: البقرة 263
    (3, 3, 2, 272), # ربع 3: البقرة 272
    (3, 4, 2, 283), # ربع 4: البقرة 283
    (3, 5, 3, 15),  # ربع 5: آل عمران 15
    (3, 6, 3, 33),  # ربع 6: آل عمران 33
    (3, 7, 3, 52),  # ربع 7: آل عمران 52
    (3, 8, 3, 75),  # ربع 8: آل عمران 75
    # الجزء 4
    (4, 1, 3, 93),  # ربع 1: آل عمران 93
    (4, 2, 3, 113), # ربع 2: آل عمران 113
    (4, 3, 3, 133), # ربع 3: آل عمران 133
    (4, 4, 3, 153), # ربع 4: آل عمران 153
    (4, 5, 3, 171), # ربع 5: آل عمران 171
    (4, 6, 3, 186), # ربع 6: آل عمران 186
    (4, 7, 4, 1),   # ربع 7: النساء 1
    (4, 8, 4, 12),  # ربع 8: النساء 12
    # الجزء 5
    (5, 1, 4, 24),  # ربع 1: النساء 24
    (5, 2, 4, 36),  # ربع 2: النساء 36
    (5, 3, 4, 58),  # ربع 3: النساء 58
    (5, 4, 4, 74),  # ربع 4: النساء 74
    (5, 5, 4, 88),  # ربع 5: النساء 88
    (5, 6, 4, 100), # ربع 6: النساء 100
    (5, 7, 4, 114), # ربع 7: النساء 114
    (5, 8, 4, 135), # ربع 8: النساء 135
    # الجزء 6
    (6, 1, 4, 148), # ربع 1: النساء 148
    (6, 2, 4, 163), # ربع 2: النساء 163
    (6, 3, 5, 1),   # ربع 3: المائدة 1
    (6, 4, 5, 12),  # ربع 4: المائدة 12
    (6, 5, 5, 27),  # ربع 5: المائدة 27
    (6, 6, 5, 41),  # ربع 6: المائدة 41
    (6, 7, 5, 51),  # ربع 7: المائدة 51
    (6, 8, 5, 67),  # ربع 8: المائدة 67
    # الجزء 7
    (7, 1, 5, 82),  # ربع 1: المائدة 82
    (7, 2, 5, 97),  # ربع 2: المائدة 97
    (7, 3, 5, 109), # ربع 3: المائدة 109
    (7, 4, 6, 13),  # ربع 4: الأنعام 13
    (7, 5, 6, 36),  # ربع 5: الأنعام 36
    (7, 6, 6, 59),  # ربع 6: الأنعام 59
    (7, 7, 6, 74),  # ربع 7: الأنعام 74
    (7, 8, 6, 95),  # ربع 8: الأنعام 95
    # الجزء 8
    (8, 1, 6, 111), # ربع 1: الأنعام 111
    (8, 2, 6, 127), # ربع 2: الأنعام 127
    (8, 3, 6, 141), # ربع 3: الأنعام 141
    (8, 4, 6, 151), # ربع 4: الأنعام 151
    (8, 5, 7, 1),   # ربع 5: الأعراف 1
    (8, 6, 7, 31),  # ربع 6: الأعراف 31
    (8, 7, 7, 47),  # ربع 7: الأعراف 47
    (8, 8, 7, 65),  # ربع 8: الأعراف 65
    # الجزء 9
    (9, 1, 7, 88),  # ربع 1: الأعراف 88
    (9, 2, 7, 117), # ربع 2: الأعراف 117
    (9, 3, 7, 142), # ربع 3: الأعراف 142
    (9, 4, 7, 156), # ربع 4: الأعراف 156
    (9, 5, 7, 171), # ربع 5: الأعراف 171
    (9, 6, 7, 189), # ربع 6: الأعراف 189
    (9, 7, 8, 1),   # ربع 7: الأنفال 1
    (9, 8, 8, 22),  # ربع 8: الأنفال 22
    # الجزء 10
    (10, 1, 8, 41), # ربع 1: الأنفال 41
    (10, 2, 8, 61), # ربع 2: الأنفال 61
    (10, 3, 9, 1),  # ربع 3: التوبة 1
    (10, 4, 9, 19), # ربع 4: التوبة 19
    (10, 5, 9, 34), # ربع 5: التوبة 34
    (10, 6, 9, 46), # ربع 6: التوبة 46
    (10, 7, 9, 60), # ربع 7: التوبة 60
    (10, 8, 9, 75), # ربع 8: التوبة 75
    # الجزء 11
    (11, 1, 9, 94),  # ربع 1: التوبة 94
    (11, 2, 9, 111), # ربع 2: التوبة 111
    (11, 3, 9, 122), # ربع 3: التوبة 122
    (11, 4, 10, 11), # ربع 4: يونس 11
    (11, 5, 10, 26), # ربع 5: يونس 26
    (11, 6, 10, 53), # ربع 6: يونس 53
    (11, 7, 10, 71), # ربع 7: يونس 71
    (11, 8, 10, 90), # ربع 8: يونس 90
    # الجزء 12
    (12, 1, 11, 6),  # ربع 1: هود 6
    (12, 2, 11, 24), # ربع 2: هود 24
    (12, 3, 11, 41), # ربع 3: هود 41
    (12, 4, 11, 61), # ربع 4: هود 61
    (12, 5, 11, 84), # ربع 5: هود 84
    (12, 6, 11, 108),# ربع 6: هود 108
    (12, 7, 12, 7),  # ربع 7: يوسف 7
    (12, 8, 12, 30), # ربع 8: يوسف 30
    # الجزء 13
    (13, 1, 12, 53), # ربع 1: يوسف 53
    (13, 2, 12, 77), # ربع 2: يوسف 77
    (13, 3, 12, 101),# ربع 3: يوسف 101
    (13, 4, 13, 5),  # ربع 4: الرعد 5
    (13, 5, 13, 19), # ربع 5: الرعد 19
    (13, 6, 13, 35), # ربع 6: الرعد 35
    (13, 7, 14, 10), # ربع 7: إبراهيم 10
    (13, 8, 14, 28), # ربع 8: إبراهيم 28
    # الجزء 14
    (14, 1, 15, 1),  # ربع 1: الحجر 1
    (14, 2, 15, 50), # ربع 2: الحجر 50
    (14, 3, 16, 1),  # ربع 3: النحل 1
    (14, 4, 16, 30), # ربع 4: النحل 30
    (14, 5, 16, 51), # ربع 5: النحل 51
    (14, 6, 16, 75), # ربع 6: النحل 75
    (14, 7, 16, 90), # ربع 7: النحل 90
    (14, 8, 16, 111),# ربع 8: النحل 111
    # الجزء 15
    (15, 1, 17, 1),  # ربع 1: الإسراء 1
    (15, 2, 17, 23), # ربع 2: الإسراء 23
    (15, 3, 17, 50), # ربع 3: الإسراء 50
    (15, 4, 17, 70), # ربع 4: الإسراء 70
    (15, 5, 17, 99), # ربع 5: الإسراء 99
    (15, 6, 18, 17), # ربع 6: الكهف 17
    (15, 7, 18, 32), # ربع 7: الكهف 32
    (15, 8, 18, 51), # ربع 8: الكهف 51
    # الجزء 16
    (16, 1, 18, 75), # ربع 1: الكهف 75
    (16, 2, 18, 99), # ربع 2: الكهف 99
    (16, 3, 19, 22), # ربع 3: مريم 22
    (16, 4, 19, 59), # ربع 4: مريم 59
    (16, 5, 20, 1),  # ربع 5: طه 1
    (16, 6, 20, 55), # ربع 6: طه 55
    (16, 7, 20, 83), # ربع 7: طه 83
    (16, 8, 20, 111),# ربع 8: طه 111
    # الجزء 17
    (17, 1, 21, 1),  # ربع 1: الأنبياء 1
    (17, 2, 21, 29), # ربع 2: الأنبياء 29
    (17, 3, 21, 51), # ربع 3: الأنبياء 51
    (17, 4, 21, 83), # ربع 4: الأنبياء 83
    (17, 5, 22, 1),  # ربع 5: الحج 1
    (17, 6, 22, 19), # ربع 6: الحج 19
    (17, 7, 22, 38), # ربع 7: الحج 38
    (17, 8, 22, 60), # ربع 8: الحج 60
    # الجزء 18
    (18, 1, 23, 1),  # ربع 1: المؤمنون 1
    (18, 2, 23, 36), # ربع 2: المؤمنون 36
    (18, 3, 23, 75), # ربع 3: المؤمنون 75
    (18, 4, 24, 1),  # ربع 4: النور 1
    (18, 5, 24, 21), # ربع 5: النور 21
    (18, 6, 24, 35), # ربع 6: النور 35
    (18, 7, 24, 53), # ربع 7: النور 53
    (18, 8, 25, 1),  # ربع 8: الفرقان 1
    # الجزء 19
    (19, 1, 25, 21), # ربع 1: الفرقان 21
    (19, 2, 25, 53), # ربع 2: الفرقان 53
    (19, 3, 26, 20), # ربع 3: الشعراء 20
    (19, 4, 26, 111),# ربع 4: الشعراء 111
    (19, 5, 26, 181),# ربع 5: الشعراء 181
    (19, 6, 27, 15), # ربع 6: النمل 15
    (19, 7, 27, 45), # ربع 7: النمل 45
    (19, 8, 27, 60), # ربع 8: النمل 60
    # الجزء 20
    (20, 1, 27, 82), # ربع 1: النمل 82
    (20, 2, 28, 14), # ربع 2: القصص 14
    (20, 3, 28, 29), # ربع 3: القصص 29
    (20, 4, 28, 51), # ربع 4: القصص 51
    (20, 5, 28, 76), # ربع 5: القصص 76
    (20, 6, 29, 7),  # ربع 6: العنكبوت 7
    (20, 7, 29, 26), # ربع 7: العنكبوت 26
    (20, 8, 29, 46), # ربع 8: العنكبوت 46
    # الجزء 21
    (21, 1, 29, 64), # ربع 1: العنكبوت 64
    (21, 2, 30, 31), # ربع 2: الروم 31
    (21, 3, 31, 1),  # ربع 3: لقمان 1
    (21, 4, 31, 22), # ربع 4: لقمان 22
    (21, 5, 32, 21), # ربع 5: السجدة 21
    (21, 6, 33, 18), # ربع 6: الأحزاب 18
    (21, 7, 33, 31), # ربع 7: الأحزاب 31
    (21, 8, 33, 51), # ربع 8: الأحزاب 51
    # الجزء 22
    (22, 1, 33, 60), # ربع 1: الأحزاب 60
    (22, 2, 34, 10), # ربع 2: سبأ 10
    (22, 3, 34, 24), # ربع 3: سبأ 24
    (22, 4, 34, 46), # ربع 4: سبأ 46
    (22, 5, 35, 15), # ربع 5: فاطر 15
    (22, 6, 35, 41), # ربع 6: فاطر 41
    (22, 7, 36, 28), # ربع 7: يس 28
    (22, 8, 36, 60), # ربع 8: يس 60
    # الجزء 23
    (23, 1, 37, 22), # ربع 1: الصافات 22
    (23, 2, 37, 83), # ربع 2: الصافات 83
    (23, 3, 37, 145),# ربع 3: الصافات 145
    (23, 4, 38, 21), # ربع 4: ص 21
    (23, 5, 38, 52), # ربع 5: ص 52
    (23, 6, 39, 8),  # ربع 6: الزمر 8
    (23, 7, 39, 32), # ربع 7: الزمر 32
    (23, 8, 39, 53), # ربع 8: الزمر 53
    # الجزء 24
    (24, 1, 39, 71), # ربع 1: الزمر 71
    (24, 2, 40, 21), # ربع 2: غافر 21
    (24, 3, 40, 41), # ربع 3: غافر 41
    (24, 4, 40, 66), # ربع 4: غافر 66
    (24, 5, 41, 9),  # ربع 5: فصلت 9
    (24, 6, 41, 25), # ربع 6: فصلت 25
    (24, 7, 41, 47), # ربع 7: فصلت 47
    (24, 8, 42, 13), # ربع 8: الشورى 13
    # الجزء 25
    (25, 1, 42, 27), # ربع 1: الشورى 27
    (25, 2, 42, 51), # ربع 2: الشورى 51
    (25, 3, 43, 24), # ربع 3: الزخرف 24
    (25, 4, 43, 57), # ربع 4: الزخرف 57
    (25, 5, 44, 17), # ربع 5: الدخان 17
    (25, 6, 45, 12), # ربع 6: الجاثية 12
    (25, 7, 46, 1),  # ربع 7: الأحقاف 1
    (25, 8, 46, 21), # ربع 8: الأحقاف 21
    # الجزء 26
    (26, 1, 47, 1),  # ربع 1: محمد 1
    (26, 2, 47, 20), # ربع 2: محمد 20
    (26, 3, 48, 10), # ربع 3: الفتح 10
    (26, 4, 48, 29), # ربع 4: الفتح 29
    (26, 5, 49, 14), # ربع 5: الحجرات 14
    (26, 6, 50, 27), # ربع 6: ق 27
    (26, 7, 51, 31), # ربع 7: الذاريات 31
    (26, 8, 52, 24), # ربع 8: الطور 24
    # الجزء 27
    (27, 1, 53, 27), # ربع 1: النجم 27
    (27, 2, 54, 28), # ربع 2: القمر 28
    (27, 3, 55, 26), # ربع 3: الرحمن 26
    (27, 4, 56, 17), # ربع 4: الواقعة 17
    (27, 5, 56, 75), # ربع 5: الواقعة 75
    (27, 6, 57, 16), # ربع 6: الحديد 16
    (27, 7, 58, 1),  # ربع 7: المجادلة 1
    (27, 8, 58, 14), # ربع 8: المجادلة 14
    # الجزء 28
    (28, 1, 59, 1),  # ربع 1: الحشر 1
    (28, 2, 59, 11), # ربع 2: الحشر 11
    (28, 3, 60, 7),  # ربع 3: الممتحنة 7
    (28, 4, 61, 6),  # ربع 4: الصف 6
    (28, 5, 62, 9),  # ربع 5: الجمعة 9
    (28, 6, 64, 1),  # ربع 6: التغابن 1
    (28, 7, 65, 6),  # ربع 7: الطلاق 6
    (28, 8, 66, 8),  # ربع 8: التحريم 8
    # الجزء 29
    (29, 1, 67, 1),  # ربع 1: الملك 1
    (29, 2, 68, 1),  # ربع 2: القلم 1
    (29, 3, 69, 1),  # ربع 3: الحاقة 1
    (29, 4, 70, 19), # ربع 4: المعارج 19
    (29, 5, 72, 1),  # ربع 5: الجن 1
    (29, 6, 73, 20), # ربع 6: المزمل 20
    (29, 7, 75, 1),  # ربع 7: القيامة 1
    (29, 8, 77, 1),  # ربع 8: المرسلات 1
    # الجزء 30
    (30, 1, 78, 1),  # ربع 1: النبأ 1
    (30, 2, 80, 1),  # ربع 2: عبس 1
    (30, 3, 82, 1),  # ربع 3: الانفطار 1
    (30, 4, 84, 1),  # ربع 4: الانشقاق 1
    (30, 5, 87, 1),  # ربع 5: الأعلى 1
    (30, 6, 90, 1),  # ربع 6: البلد 1
    (30, 7, 94, 1),  # ربع 7: الشرح 1
    (30, 8, 100, 1), # ربع 8: العاديات 1
]

# مسارات ملفات الروايات
RIWAYAT = {
    'hafs': 'UthmanicHafs_v2-0/UthmanicHafs_v2-0 data/HafsData_v2-0.json',
    'douri': 'UthmanicDouri_v2-0/UthmanicDouri_v2-0 data/DouriData_v2-0.json',
    'warsh': 'UthmanicWarsh_v2-1/UthmanicWarsh_v2-1 data/WarshData_v2-1.json',
    'qaloun': 'UthmanicQaloun_v2/UthmanicQaloun_v2-1 data/QalounData_v2-1.json',
    'shuba': 'UthmanicShuba_v2-0/UthmanicShuba_v2-0 data/ShubaData_v2-0.json',
    'sousi': 'UthmanicSousi_v2/UthmanicSousi_v2-0 data/SousiData_v2-0.json'
}

RIWAYAT_NAMES = {
    'hafs': 'حفص عن عاصم',
    'douri': 'الدوري عن أبي عمرو',
    'warsh': 'ورش عن نافع',
    'qaloun': 'قالون عن نافع',
    'shuba': 'شعبة عن عاصم',
    'sousi': 'السوسي عن أبي عمرو'
}

def get_page_for_ayah(data, sura_no, aya_no):
    """الحصول على رقم الصفحة لآية معينة"""
    for ayah in data:
        if ayah['sura_no'] == sura_no and ayah['aya_no'] == aya_no:
            return ayah['page']
    return None

def create_ahzab_index(riwayah_key, json_path):
    """إنشاء فهرس الأحزاب والأرباع لرواية"""
    
    with open(json_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # إنشاء قاموس للوصول السريع
    ayah_map = {}
    for ayah in data:
        key = (ayah['sura_no'], ayah['aya_no'])
        ayah_map[key] = ayah
    
    # إنشاء فهرس الأحزاب
    ahzab = []
    quarters = []
    
    for i, q in enumerate(QUARTERS):
        juz = q[0]
        quarter_in_juz = q[1]
        sura = q[2]
        aya = q[3] if len(q) > 3 else 1
        
        # رقم الربع الكلي (1-240)
        quarter_num = (juz - 1) * 8 + quarter_in_juz
        
        # رقم الحزب (1-60)
        hizb_num = (juz - 1) * 2 + (1 if quarter_in_juz <= 4 else 2)
        
        # ربع الحزب (1-4)
        quarter_in_hizb = quarter_in_juz if quarter_in_juz <= 4 else quarter_in_juz - 4
        
        # الحصول على الصفحة
        page = get_page_for_ayah(data, sura, aya)
        
        # الحصول على اسم السورة
        sura_name = ""
        if (sura, aya) in ayah_map:
            sura_name = ayah_map[(sura, aya)]['sura_name_ar'].strip()
        
        quarter_data = {
            'quarter_num': quarter_num,
            'juz': juz,
            'hizb': hizb_num,
            'quarter_in_hizb': quarter_in_hizb,
            'sura_no': sura,
            'sura_name': sura_name,
            'aya_no': aya,
            'page': page
        }
        quarters.append(quarter_data)
    
    # تجميع الأحزاب
    for hizb_num in range(1, 61):
        juz = (hizb_num + 1) // 2
        hizb_in_juz = 1 if hizb_num % 2 == 1 else 2
        
        # أرباع هذا الحزب
        hizb_quarters = [q for q in quarters if q['hizb'] == hizb_num]
        
        if hizb_quarters:
            ahzab.append({
                'hizb_num': hizb_num,
                'juz': juz,
                'hizb_in_juz': hizb_in_juz,
                'start_sura': hizb_quarters[0]['sura_no'],
                'start_sura_name': hizb_quarters[0]['sura_name'],
                'start_aya': hizb_quarters[0]['aya_no'],
                'start_page': hizb_quarters[0]['page'],
                'quarters': hizb_quarters
            })
    
    return {
        'riwayah': riwayah_key,
        'riwayah_name': RIWAYAT_NAMES[riwayah_key],
        'total_ahzab': len(ahzab),
        'total_quarters': len(quarters),
        'ahzab': ahzab,
        'quarters': quarters
    }

def main():
    print("=" * 70)
    print("إنشاء فهرس الأحزاب والأرباع لكل رواية")
    print("=" * 70)
    
    output_dir = Path("data/quran_index")
    output_dir.mkdir(parents=True, exist_ok=True)
    
    all_ahzab = {}
    
    for riwayah_key, json_path in RIWAYAT.items():
        print(f"\n{RIWAYAT_NAMES[riwayah_key]}...")
        
        if not Path(json_path).exists():
            print(f"   ⚠ الملف غير موجود: {json_path}")
            continue
        
        ahzab_index = create_ahzab_index(riwayah_key, json_path)
        all_ahzab[riwayah_key] = ahzab_index
        
        # حفظ فهرس الأحزاب
        output_path = output_dir / f"{riwayah_key}_ahzab.json"
        with open(output_path, 'w', encoding='utf-8') as f:
            json.dump(ahzab_index, f, ensure_ascii=False, indent=2)
        
        print(f"   ✓ {ahzab_index['total_ahzab']} حزب")
        print(f"   ✓ {ahzab_index['total_quarters']} ربع")
        
        # عرض أمثلة
        print(f"\n   أمثلة:")
        for hizb in ahzab_index['ahzab'][:3]:
            print(f"      الحزب {hizb['hizb_num']}: {hizb['start_sura_name']} آية {hizb['start_aya']} - صفحة {hizb['start_page']}")
    
    # حفظ الفهرس الموحد
    unified_path = output_dir / "all_ahzab_index.json"
    with open(unified_path, 'w', encoding='utf-8') as f:
        json.dump(all_ahzab, f, ensure_ascii=False, indent=2)
    
    # تحديث الفهرس الرئيسي
    print("\n" + "=" * 70)
    print("تحديث الفهارس الرئيسية...")
    print("=" * 70)
    
    for riwayah_key in RIWAYAT.keys():
        index_path = output_dir / f"{riwayah_key}_index.json"
        if index_path.exists() and riwayah_key in all_ahzab:
            with open(index_path, 'r', encoding='utf-8') as f:
                index = json.load(f)
            
            # إضافة الأحزاب للفهرس الرئيسي
            index['ahzab'] = all_ahzab[riwayah_key]['ahzab']
            index['quarters'] = all_ahzab[riwayah_key]['quarters']
            index['total_ahzab'] = all_ahzab[riwayah_key]['total_ahzab']
            index['total_quarters'] = all_ahzab[riwayah_key]['total_quarters']
            
            with open(index_path, 'w', encoding='utf-8') as f:
                json.dump(index, f, ensure_ascii=False, indent=2)
            
            print(f"   ✓ تم تحديث {riwayah_key}_index.json")
    
    print(f"\nتم الحفظ في: {output_dir}")

if __name__ == "__main__":
    main()

